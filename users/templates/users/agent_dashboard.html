{% extends "base.html" %}
{% load static %}

{% block title %}Booking Details - {{ booking.full_name }}{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-teal-500 to-cyan-600 py-12 px-4">
    <div class="max-w-4xl mx-auto">
        <!-- Back Button -->
        <a href="{% url 'agent_dashboard' %}" class="inline-flex items-center gap-2 text-white hover:text-gray-100 mb-6 transition-colors">
            <i data-feather="arrow-left" class="w-5 h-5"></i>
            <span class="font-semibold">Back to Dashboard</span>
        </a>

        <!-- Main Card -->
        <div class="bg-white rounded-2xl shadow-2xl overflow-hidden">
            <!-- Header -->
            <div class="bg-gradient-to-r from-teal-600 to-cyan-600 p-8 text-white">
                <div class="flex items-center justify-between mb-4">
                    <h1 class="text-3xl font-bold">Booking Details</h1>
                    <span class="status-badge status-{{ booking.status }} text-lg px-6 py-2">
                        {% if booking.status == 'pending' %}‚è≥{% elif booking.status == 'confirmed' %}‚úÖ{% elif booking.status == 'completed' %}üéâ{% else %}‚ùå{% endif %}
                        {{ booking.get_status_display }}
                    </span>
                </div>
                <p class="text-white/90">Booking ID: {{ booking.booking_id }}</p>
            </div>

            <div class="p-8">
                <!-- Customer Information -->
                <div class="mb-8">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                        <i data-feather="user" class="w-6 h-6 text-teal-600"></i>
                        Customer Information
                    </h2>
                    <div class="grid md:grid-cols-2 gap-6 bg-gray-50 rounded-xl p-6">
                        <div>
                            <label class="text-sm font-semibold text-gray-500 uppercase tracking-wide">Full Name</label>
                            <p class="text-lg font-medium text-gray-800 mt-1">{{ booking.full_name }}</p>
                        </div>
                        <div>
                            <label class="text-sm font-semibold text-gray-500 uppercase tracking-wide">Email</label>
                            <p class="text-lg font-medium text-gray-800 mt-1">{{ booking.email }}</p>
                        </div>
                        <div>
                            <label class="text-sm font-semibold text-gray-500 uppercase tracking-wide">Phone</label>
                            <p class="text-lg font-medium text-gray-800 mt-1">{{ booking.phone }}</p>
                        </div>
                        <div>
                            <label class="text-sm font-semibold text-gray-500 uppercase tracking-wide">User Account</label>
                            <p class="text-lg font-medium text-gray-800 mt-1">{{ booking.user.username }}</p>
                        </div>
                    </div>
                </div>

                <!-- Package Information -->
                <div class="mb-8">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                        <i data-feather="map-pin" class="w-6 h-6 text-teal-600"></i>
                        Package Details
                    </h2>
                    <div class="bg-gradient-to-r from-teal-50 to-cyan-50 rounded-xl p-6">
                        <h3 class="text-2xl font-bold text-gray-800 mb-2">{{ booking.package.name }}</h3>
                        <p class="text-gray-600 mb-4">{{ booking.package.description }}</p>
                        <div class="grid md:grid-cols-3 gap-4">
                            <div>
                                <label class="text-sm font-semibold text-gray-500 uppercase tracking-wide">Destination</label>
                                <p class="text-lg font-medium text-gray-800 mt-1">{{ booking.package.destination }}</p>
                            </div>
                            <div>
                                <label class="text-sm font-semibold text-gray-500 uppercase tracking-wide">Duration</label>
                                <p class="text-lg font-medium text-gray-800 mt-1">{{ booking.package.duration_days }} days</p>
                            </div>
                            <div>
                                <label class="text-sm font-semibold text-gray-500 uppercase tracking-wide">Price per Person</label>
                                <p class="text-lg font-medium text-gray-800 mt-1">${{ booking.package.price }}</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Booking Information -->
                <div class="mb-8">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                        <i data-feather="calendar" class="w-6 h-6 text-teal-600"></i>
                        Booking Information
                    </h2>
                    <div class="grid md:grid-cols-2 gap-6 bg-gray-50 rounded-xl p-6">
                        <div>
                            <label class="text-sm font-semibold text-gray-500 uppercase tracking-wide">Travel Date</label>
                            <p class="text-lg font-medium text-gray-800 mt-1">{{ booking.travel_date|date:"F d, Y" }}</p>
                        </div>
                        <div>
                            <label class="text-sm font-semibold text-gray-500 uppercase tracking-wide">Number of Travelers</label>
                            <p class="text-lg font-medium text-gray-800 mt-1">{{ booking.number_of_people }} {{ booking.number_of_people|pluralize:"person,people" }}</p>
                        </div>
                        <div>
                            <label class="text-sm font-semibold text-gray-500 uppercase tracking-wide">Booking Date</label>
                            <p class="text-lg font-medium text-gray-800 mt-1">{{ booking.created_at|date:"F d, Y g:i A" }}</p>
                        </div>
                        <div>
                            <label class="text-sm font-semibold text-gray-500 uppercase tracking-wide">Last Updated</label>
                            <p class="text-lg font-medium text-gray-800 mt-1">{{ booking.updated_at|date:"F d, Y g:i A" }}</p>
                        </div>
                    </div>
                </div>

                <!-- Guide Information -->
                {% if booking.guide %}
                <div class="mb-8">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                        <i data-feather="user-check" class="w-6 h-6 text-teal-600"></i>
                        Guide Information
                    </h2>
                    <div class="grid md:grid-cols-2 gap-6 bg-gray-50 rounded-xl p-6">
                        <div>
                            <label class="text-sm font-semibold text-gray-500 uppercase tracking-wide">Guide Name</label>
                            <p class="text-lg font-medium text-gray-800 mt-1">{{ booking.guide }}</p>
                        </div>
                        <div>
                            <label class="text-sm font-semibold text-gray-500 uppercase tracking-wide">Guide Fee</label>
                            <p class="text-lg font-medium text-gray-800 mt-1">${{ booking.guide_amount|floatformat:2 }}</p>
                        </div>
                        {% if booking.guide_rating %}
                        <div>
                            <label class="text-sm font-semibold text-gray-500 uppercase tracking-wide">Rating</label>
                            <p class="text-lg font-medium text-gray-800 mt-1">‚≠ê {{ booking.guide_rating }}/5.0</p>
                        </div>
                        {% endif %}
                    </div>
                    {% if booking.guide_review %}
                    <div class="mt-4 bg-blue-50 border-l-4 border-blue-400 rounded-lg p-4">
                        <label class="text-sm font-semibold text-gray-700 uppercase tracking-wide block mb-2">Customer Review</label>
                        <p class="text-gray-700">{{ booking.guide_review }}</p>
                    </div>
                    {% endif %}
                </div>
                {% endif %}

                <!-- Special Requests -->
                {% if booking.special_requests %}
                <div class="mb-8">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                        <i data-feather="message-square" class="w-6 h-6 text-teal-600"></i>
                        Special Requests
                    </h2>
                    <div class="bg-yellow-50 border-l-4 border-yellow-400 rounded-lg p-6">
                        <p class="text-gray-700">{{ booking.special_requests }}</p>
                    </div>
                </div>
                {% endif %}

                <!-- Payment Summary -->
                <div class="mb-8">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                        <i data-feather="dollar-sign" class="w-6 h-6 text-teal-600"></i>
                        Payment Summary
                    </h2>
                    <div class="bg-gradient-to-r from-teal-50 to-cyan-50 rounded-xl p-6">
                        <div class="space-y-3">
                            <div class="flex justify-between text-gray-700">
                                <span>Package Price (per person)</span>
                                <span class="font-medium">${{ booking.package.price }}</span>
                            </div>
                            <div class="flex justify-between text-gray-700">
                                <span>Number of Travelers</span>
                                <span class="font-medium">√ó {{ booking.number_of_people }}</span>
                            </div>
                            {% if booking.guide_amount %}
                            <div class="flex justify-between text-gray-700">
                                <span>Guide Fee</span>
                                <span class="font-medium">${{ booking.guide_amount }}</span>
                            </div>
                            {% endif %}
                            <div class="border-t-2 border-teal-200 pt-3 flex justify-between items-center">
                                <span class="text-xl font-bold text-gray-800">Total Amount</span>
                                <span class="text-3xl font-bold gradient-text">${{ booking.total_amount|floatformat:2 }}</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="flex flex-wrap gap-4 pt-6 border-t border-gray-200">
                    {% if booking.status == 'pending' %}
                        <button class="btn btn-success text-lg" onclick="updateStatus('{{ booking.booking_id }}', 'confirmed')">
                            <i data-feather="check" class="w-5 h-5"></i>
                            <span>Confirm Booking</span>
                        </button>
                        <button class="btn btn-danger text-lg" onclick="updateStatus('{{ booking.booking_id }}', 'cancelled')">
                            <i data-feather="x" class="w-5 h-5"></i>
                            <span>Cancel Booking</span>
                        </button>
                    {% elif booking.status == 'confirmed' %}
                        <button class="btn btn-primary text-lg" onclick="updateStatus('{{ booking.booking_id }}', 'completed')">
                            <i data-feather="check-circle" class="w-5 h-5"></i>
                            <span>Mark as Completed</span>
                        </button>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .status-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.375rem;
        padding: 0.375rem 0.875rem;
        border-radius: 9999px;
        font-size: 0.8125rem;
        font-weight: 600;
        text-transform: capitalize;
    }
    
    .status-pending {
        background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
        color: #92400e;
        border: 2px solid #fcd34d;
    }
    
    .status-confirmed {
        background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
        color: #065f46;
        border: 2px solid #6ee7b7;
    }
    
    .status-completed {
        background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
        color: #1e40af;
        border: 2px solid #93c5fd;
    }
    
    .status-cancelled {
        background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
        color: #991b1b;
        border: 2px solid #fca5a5;
    }
    
    .btn {
        padding: 0.75rem 1.5rem;
        border-radius: 9999px;
        font-weight: 600;
        transition: all 0.3s;
        cursor: pointer;
        border: none;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    
    .btn-success {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
    }
    
    .btn-danger {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        color: white;
    }
    
    .btn-primary {
        background: linear-gradient(135deg, #0d9488 0%, #14b8a6 100%);
        color: white;
    }
    
    .gradient-text {
        background: linear-gradient(135deg, #0d9488 0%, #14b8a6 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }
</style>

<script>
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    async function updateStatus(bookingId, newStatus) {
        if (!confirm(`Are you sure you want to ${newStatus} this booking?`)) {
            return;
        }

        try {
            const response = await fetch(`/bookings/agent/booking/${bookingId}/update-status/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                },
                body: JSON.stringify({ status: newStatus })
            });

            const data = await response.json();

            if (data.success) {
                window.location.reload();
            } else {
                alert('Error: ' + (data.error || 'Failed to update booking'));
            }
        } catch (error) {
            console.error('Error:', error);
            alert('An error occurred. Please try again.');
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        feather.replace();
    });
</script>
{% endblock %}